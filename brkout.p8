pico-8 cartridge // http://www.pico-8.com
version 18
__lua__

function init()
	palt(0,false)
	palt(1,true)
	start(ball())
	start(player)
	start_bricks()
end

function tick()
	cls(1)
	print(num_balls)
end


-->8
ent={}

function start(e)
	if e.i then
		e:i()
	end
	add(ent,e)
end

function _init()
	init()
end

function _update()
	tick()
	i=1
	while i<=#ent do
		ent[i]:t()
		if ent[i].d then
			del(ent,ent[i])
		else
			i=i+1
		end
	end
end


-->8
player={
	x=60,
	y=110,
	ox=60,
	oy=110,
	hit=function(self,bx,by)
		return bx > self.x-8 and 
									bx < self.x+8 and 
									by > self.y-2 and 
									by < self.y+2
	end,
	t=function(self)
		self.ox = self.x
		self.oy = self.y
		spr(2,self.x-8,self.y)
		spr(4,self.x,self.y)
		if btn(0) and self.x > 0 then
			self.x=self.x-4
		elseif btn(1) and self.x < 128 then
			self.x=self.x+4
		end
	end
}


-->8
num_balls=0

ball=function()
	return {
		i=function(self)
			self.held = true
			self.x = player.x
			self.y = player.y
		end,
		t=function(self)
			self.ox=self.x
			self.oy=self.y
			if btnp(4) then
				self.held = false
				local dr = sgn(player.x-player.ox)
				self.vx = dr
				self.vy = -1
			end
			if self.held then
				self.x = player.x
				self.y = player.y
			else
				self.x = self.x+self.vx
				self.y = self.y+self.vy
				if self.x < 2 then
					self.x = 2
					self.vx = -self.vx
				end
				if self.x > 126 then
					self.x = 126
					self.vx = -self.vx
				end
				if self.y < 2 then
					self.y = 2
					self.vy = -self.vy
				end
				if self.y > 130 then
					self.d = true
					num_balls=num_balls-1
					if num_balls==0 then
						-- lose
					end
				end
				if player:hit(self.x,self.y) then
					self.vy = -abs(self.vy)
					if self.x > player.x+3 then
						self.vx = abs(self.vx)
					elseif self.x < player.x-3 then
						self.vx = -abs(self.vx)
					end
				end
				for i=1,#bricks do
					if bricks[i]:hit(self.x,self.y) then
						if self.oy < self.y then
							self.vy = -abs(self.vy)
						elseif self.oy > self.y then
							self.vy = abs(self.vy)
						else
							if self.ox < self.x then
								self.vx = -abs(self.vx)
							elseif self.ox > self.x then
								self.vx = abs(self.vx)
							end
						end
						local b2=ball()
						self:split(b2)
					end
				end
			end
			spr(1,self.x-2,self.y-2)
		end,
		split=function(self,other)
			num_balls=num_balls+1
			start(other)
			other.x=self.x
			other.y=self.y
			other.vx=-self.vx--*(rnd(10)/10+0.5)
			other.vy=self.vy
			other.held=false
		end
	}
end

-->8
bricks={}
function start_bricks()
	for y=0,5 do
		for x=0,15 do
		 local b=brick(x,y)
		 add(bricks,b)
			start(b)
		end
	end
end

function brick(bx,by)
	return {
		x=bx*8,
		y=by*4+24,
		s=by+16,
		t=function(self)
			spr(self.s,self.x,self.y)
		end,
		hit=function(self,bx,by)
			if self.d then 
				return false
			end
			if bx+2>self.x+0 and
						bx-2<self.x+8 and
						by+2>self.y+0 and
						by-2<self.y+4 then
				self.d=true
				return true
			else
				return false
			end
		end
	}
end

__gfx__
00000000176111111777777777777777777777711111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
0000000076d511117aaaaaaaaaaaaaaaaaaaaaa71111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
007007006d501111a9999999999999999999999a1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
00077000150111111222222222222222222222211111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
00077000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
00700700111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
00000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
00000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
7eeeeee87aaaaaa97bbbbbb37666666c7ffffffe6dddddd211111111111111111111111111111111111111111111111111111111111111111111111111111111
e8888885a9999995b33333356cccccc5feeeeee5d222222511111111111111111111111111111111111111111111111111111111111111111111111111111111
e8888885a9999995b33333356cccccc5feeeeee5d222222511111111111111111111111111111111111111111111111111111111111111111111111111111111
855555519555555135555551c5555551555555512555555111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
__map__
1010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1212121212121212121212121212121200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313131313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1414141414141414141414141414141400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515151515151515151515151515151500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
